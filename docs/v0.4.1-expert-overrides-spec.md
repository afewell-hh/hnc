# HNC v0.4.1: Expert Overrides with Guardrails

## Overview
Small, surgical addition of manual overrides for expert users while maintaining strict safety guardrails. No UX upheaval; pure additive functionality.

## Core Additions

### 1. Field Provenance System
Track origin of each computed value:
- `origin: 'auto' | 'user' | 'import'` for spines, leaves, and per-class counts
- Automatic marking during computation vs manual override
- Persistence in fabric specs with provenance metadata

### 2. Pure Rule Engine
Implement `src/domain/rules.ts` with:
```typescript
interface RuleEvaluation {
  errors: Issue[]     // Block Save - must be zero
  warnings: Issue[]   // Allow Save - show prominently
  info: Issue[]       // FYI only
}

function evaluate(spec: FabricSpec, derived: DerivedTopology, catalog: SwitchCatalog): RuleEvaluation
```

### 3. Save Gating Integration
- Post-compute rule evaluation in app.machine.ts
- Save button disabled when `errors.length > 0`
- Warning/info display without blocking

## Initial Policy Rules

### ❌ ERRORS (Block Save)
- **Capacity Exceeded**: Spine/leaf port count exceeds switch model limits
- **Invalid Ranges**: Empty or negative assignable port ranges
- **Resource Impossible**: Configuration cannot physically exist

### ⚠️ WARNINGS (Allow Save)
- **Uplinks Not Divisible**: Uplinks not evenly divisible by spine count
- **MC-LAG Odd Count**: MC-LAG enabled with odd leaf count
- **ES-LAG Single-NIC**: ES-LAG endpoints with single NIC
- **Model Mismatch**: Recommended profiles don't match selected models

### ℹ️ INFO (FYI Only)
- **Sub-optimal Ratios**: Oversubscription outside recommended ranges
- **Port Utilization**: Low/high port utilization warnings

## UI Additions

### Issues Panel
- Collapsible section showing current errors/warnings/info
- Color-coded by severity (red/orange/blue)
- Clear descriptions with suggested fixes
- "Dismiss" for warnings/info only

### Override Indicators
- Small "Overrides active" chips on manually set fields
- Hover tooltip showing original auto-calculated value
- Reset-to-auto button for each overridden field

## Work Packets

### WP-OVR1: Core Rules Engine
**Scope**: Backend logic, no UI changes
- Add provenance fields to FabricSpec and DerivedTopology types
- Implement `src/domain/rules.ts` with evaluation engine
- Integrate into app.machine.ts post-computation
- Unit tests for all rule categories
- **Exit Criteria**: `tsc` + unit tests green; existing stories unchanged

### WP-OVR2: UI Affordances  
**Scope**: Visual integration, new stories
- Add Issues panel component with collapsible design
- Add override chips and reset buttons to form fields
- Two new stories: (a) Override with warnings (Save enabled), (b) Override with errors (Save disabled)
- Use semantic selectors only, no data-testids
- **Exit Criteria**: Storybook build + tests green

## Implementation Constraints

- **Pure Additive**: Zero changes to existing computation paths
- **Backward Compatible**: All existing specs continue working
- **No UX Upheaval**: Existing workflows unchanged
- **Semantic UI**: Stories use semantic selectors, maintain existing patterns
- **Safe Defaults**: All rules default to current auto-behavior

## Success Criteria

1. **Safety First**: Impossible configurations blocked, questionable ones warned
2. **Expert Friendly**: Power users can override with clear consequences  
3. **Quality Gates**: All existing CI passes unchanged
4. **Documentation**: Rules clearly documented with examples
5. **Extensible**: Rule engine can grow with additional policies

This positions HNC v0.4.1 as a controlled, expert-friendly enhancement that maintains the safety and reliability of the automatic calculations while providing escape hatches for advanced users.