# HNC v0.5 Track A — Wiring Generation Specification

## Overview
Generate port-accurate wiring diagrams from the allocator, providing deterministic port assignments for servers, switches, and connections. This builds on v0.4.1's expert overrides to deliver production-ready wiring outputs.

## Work Packets

### WP-W1 — Generate Port-Accurate Wiring YAML
**Goal**: Generate complete wiring diagram YAML from allocator with concrete port IDs

```typescript
// New domain/wiring-generator.ts
export interface WiringPort {
  portId: string         // e.g., "Ethernet1/1"
  portType: 'fabric' | 'server' | 'management'
  speed: string          // e.g., "100G"
  connected?: {
    deviceId: string
    portId: string
  }
}

export interface WiringDevice {
  deviceId: string
  deviceType: 'spine' | 'leaf' | 'server'
  model: string
  ports: WiringPort[]
  location?: {
    rack: string
    unit: number
  }
}

export interface DetailedWiring {
  fabricId: string
  version: string
  generated: string
  devices: WiringDevice[]
  connections: Connection[]
  portMappings: Map<string, PortAssignment>
}
```

**Claude-Flow Command**:
```bash
npx claude-flow@alpha hive-mind spawn \
"WP-W1: Implement wiring-generator.ts that takes allocator output and generates detailed port assignments. Map each uplink/downlink to specific ports (Ethernet1/1-48 for leaves, 1/1-32 for spines). Include server connections with NIC ports. Generate YAML with devices/connections/portMappings sections. Unit tests for deterministic port assignment. Exit: tsc + tests green."
--agents 2 --claude
```

### WP-W2 — Storybook Wiring Preview Flows
**Goal**: Visual wiring diagram previews per-class and multi-class

```typescript
// New components/WiringPreview.tsx
export interface WiringPreviewProps {
  wiring: DetailedWiring
  viewMode: 'per-class' | 'multi-class' | 'compact'
  highlightClass?: string
  onPortClick?: (device: string, port: string) => void
}

// Stories to create:
// - PerClassWiring: Show single leaf class wiring
// - MultiClassWiring: Show all classes together
// - PortHighlighting: Interactive port selection
// - CompactView: Summary table format
```

**Claude-Flow Command**:
```bash
npx claude-flow@alpha hive-mind spawn \
"WP-W2: Create WiringPreview component with per-class/multi-class/compact views. Visual port grid for switches, connection lines for links. Add 4 Storybook stories: PerClassWiring (single class focus), MultiClassWiring (all classes), PortHighlighting (click interactions), CompactView (table format). Use semantic selectors. Exit: build-storybook + test-storybook green."
--agents 2 --claude
```

### WP-W3 — GitHub PR Mode (Feature Flag)
**Goal**: Save creates PR with FGD changes (no auto-merge)

```typescript
// Enhanced features/github-provider.ts
export interface PROptions {
  title: string
  body: string
  branch: string
  baseBranch: string
  labels?: string[]
  reviewers?: string[]
  draft?: boolean
}

export async function createFGDPullRequest(
  fabricId: string,
  wiring: DetailedWiring,
  options: PROptions
): Promise<{ prUrl: string; prNumber: number }>
```

**Claude-Flow Command**:
```bash
npx claude-flow@alpha hive-mind spawn \
"WP-W3: Add PR mode to GitHubProvider (FEATURE_GIT_PR=true). On Save, create branch 'hnc-update/<fabricId>-<timestamp>', commit FGD + wiring YAML, open PR against main with title 'Update fabric <name>' and body with change summary. No auto-merge. Add Storybook story showing PR creation flow. Exit: integration test with mock GitHub API green."
--agents 2 --claude
```

## Integration Points

### With v0.4.1 Expert Overrides
- Wiring respects manual port overrides
- Issues panel shows port conflicts
- Save gate applies to wiring generation

### With Allocator
- Use existing range assignments
- Maintain deterministic ordering
- Preserve VLAN/subnet mappings

### With FGD Export
- Add `wiring/` subdirectory in FGD
- Include `devices.yaml`, `connections.yaml`, `port-map.yaml`
- Version wiring schema separately

## Testing Strategy

### Unit Tests
- Deterministic port assignment
- Multi-class port allocation
- Port conflict detection
- YAML serialization

### Integration Tests  
- Allocator → Wiring flow
- Save → PR creation
- FGD structure validation

### E2E Tests
- Configure → Compute → Preview Wiring → Save
- PR creation flow (with mock)

## Migration Path

1. **v0.5.0-alpha**: Core wiring generation (WP-W1)
2. **v0.5.1-alpha**: Visual previews (WP-W2)  
3. **v0.5.2-alpha**: GitHub PR mode (WP-W3)

## Success Metrics

- Port assignments 100% deterministic
- Wiring YAML validates against schema
- PR creation < 3 seconds
- Zero port conflicts in generated output
- Storybook stories all passing

## Example Output

```yaml
# wiring/devices.yaml
devices:
  - deviceId: spine-001
    deviceType: spine
    model: DS3000
    location:
      rack: R1
      unit: 40
    ports:
      - portId: Ethernet1/1
        portType: fabric
        speed: 100G
        connected:
          deviceId: leaf-001
          portId: Ethernet1/49
          
  - deviceId: leaf-001
    deviceType: leaf
    model: DS2000
    location:
      rack: R1
      unit: 20
    ports:
      - portId: Ethernet1/1
        portType: server
        speed: 25G
        connected:
          deviceId: server-001
          portId: eth0
```

## Next Steps

After v0.5 Track A completion:
- Track B: Interactive mapping UI for port pinning
- Track C: Multi-site federation support
- Track D: Ansible playbook generation

## Implementation Order

1. Run WP-W1 first (core generation logic)
2. Run WP-W2 after W1 completes (UI preview)
3. Run WP-W3 after W2 (GitHub integration)

Each work packet is designed to complete independently and pass all tests before moving to the next.