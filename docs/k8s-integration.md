# Kubernetes Integration (INT-K8S1)

The HNC Kubernetes integration provides read-only validation of deployed resources against generated YAML manifests. This integration is designed for GitOps workflows where YAML is generated by HNC and applied separately to Kubernetes clusters.

## Overview

- **Read-only**: No resource creation/modification, only validation
- **Namespace isolated**: Uses `hnc-it-<runId>` pattern for safe isolation
- **Label-based filtering**: Uses `hncRunId` labels for resource identification
- **Exponential backoff**: Waits for GitOps resource application with configurable retry logic
- **Optional by default**: Feature flag controlled, doesn't affect core functionality

## Prerequisites

1. **Kubernetes cluster access**: Valid kubeconfig file
2. **Feature flag enabled**: `FEATURE_K8S=true` environment variable
3. **Dependencies**: `@kubernetes/client-node` package (automatically installed)

## Quick Start

### 1. Try the Demo (No Cluster Required)

```bash
# Run the standalone demo to see how it works
npm run k8s:demo -- --run-id test-123 --fgd-file examples/sample-fabric.yaml --demo --wait
```

### 2. Enable for Real Cluster

```bash
# Enable K8s integration
export FEATURE_K8S=true

# Optional: Set custom kubeconfig path
export KUBECONFIG=/path/to/your/kubeconfig
```

### 3. Generate FGD YAML

First, generate your fabric configuration YAML using HNC:

```bash
# Generate fabric YAML (example)
node src/index.js --output fabric.yaml --run-id test-123
```

### 4. Run Validation

```bash
# Basic validation (immediate comparison)
npm run k8s:validate -- --run-id test-123 --fgd-file fabric.yaml

# GitOps validation (wait for resources, then compare)  
npm run k8s:validate -- --run-id test-123 --fgd-file fabric.yaml --wait
```

## CLI Reference

### Command Syntax

```bash
node tools/int-k8s.js --run-id <runId> --fgd-file <path> [options]
```

### Required Parameters

- `--run-id <string>`: Unique run identifier for namespace isolation
- `--fgd-file <path>`: Path to the FGD YAML file to validate

### Optional Parameters

| Option | Description | Default |
|--------|-------------|---------|
| `--wait` | Wait for resources before comparing | false |
| `--max-retries <n>` | Maximum retry attempts | 10 |
| `--initial-delay <ms>` | Initial delay between retries | 1000ms |
| `--max-delay <ms>` | Maximum delay between retries | 30000ms |
| `--force-enable` | Force enable K8s integration | false |
| `--verbose` | Show detailed error information | false |
| `--help` | Show help message | - |

### Exit Codes

- `0`: Success - all resources match expected state
- `1`: Validation failed or error occurred

## Examples

### Development Testing

```bash
# Quick validation without waiting
node tools/int-k8s.js \
  --run-id dev-$(date +%s) \
  --fgd-file ./output/fabric.yaml \
  --force-enable
```

### GitOps Workflow

```bash
# Wait for GitOps controller to apply resources
node tools/int-k8s.js \
  --run-id prod-release-v1.2.3 \
  --fgd-file ./manifests/production-fabric.yaml \
  --wait \
  --max-retries 20 \
  --initial-delay 5000
```

### CI/CD Integration

```bash
# In your CI pipeline
export FEATURE_K8S=true
export KUBECONFIG=/etc/kubernetes/ci-kubeconfig

# Deploy with ArgoCD/Flux
argocd app sync my-fabric-app

# Validate deployment
node tools/int-k8s.js \
  --run-id ci-${BUILD_NUMBER} \
  --fgd-file ./generated/fabric.yaml \
  --wait \
  --max-retries 15 \
  --verbose
```

## Resource Comparison

### Supported Resource Types

The integration currently validates:
- ConfigMaps
- Services  
- Deployments
- (Extensible for additional types)

### Label Requirements

All resources must have the `hncRunId` label:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fabric-config
  namespace: hnc-it-test-123
  labels:
    hncRunId: test-123  # Required for filtering
data:
  # ... config data
```

### Comparison Logic

The tool compares:
1. **Missing resources**: Expected in FGD but not found in cluster
2. **Extra resources**: Found in cluster but not in FGD
3. **Different resources**: Present in both but with differences

Differences checked:
- API version mismatches
- Label value differences
- (Spec comparison can be extended)

## Namespace Isolation

### Namespace Pattern

- Generated namespace: `hnc-it-<runId>`
- Example: `hnc-it-prod-release-v1.2.3`

### Benefits

- **Isolation**: Different runs don't interfere
- **Cleanup**: Easy to identify and clean up test resources  
- **Safety**: Prevents accidental validation against wrong resources

### Resource Labeling

Resources are filtered by label: `hncRunId=<runId>`

```yaml
metadata:
  labels:
    hncRunId: "{{ .Values.runId }}"  # In Helm templates
    # or hardcoded in YAML
```

## GitOps Integration

### Exponential Backoff

When using `--wait`, the tool implements exponential backoff:

1. **Initial delay**: 1 second (configurable)
2. **Backoff multiplier**: 2x
3. **Maximum delay**: 30 seconds (configurable)
4. **Maximum retries**: 10 (configurable)

### Workflow Example

```bash
# 1. Generate YAML
node src/index.js --config fabric.json --output manifests/fabric.yaml

# 2. Commit and push (triggers GitOps)
git add manifests/fabric.yaml
git commit -m "Update fabric configuration"
git push origin main

# 3. Wait for GitOps controller (ArgoCD/Flux) to apply
# This happens automatically

# 4. Validate deployment
node tools/int-k8s.js \
  --run-id prod-$(git rev-parse --short HEAD) \
  --fgd-file manifests/fabric.yaml \
  --wait
```

## Troubleshooting

### Connection Issues

```bash
# Check cluster connectivity
kubectl cluster-info

# Verify kubeconfig
kubectl config current-context

# Test with force-enable
node tools/int-k8s.js --run-id test --fgd-file test.yaml --force-enable --verbose
```

### Resource Not Found

```bash
# Check namespace exists
kubectl get namespace hnc-it-<runId>

# Check resources in namespace  
kubectl get all -n hnc-it-<runId> -l hncRunId=<runId>

# Check labels
kubectl get all -n hnc-it-<runId> --show-labels
```

### Permission Issues

Ensure your kubeconfig has read permissions for:
- Namespaces (list)
- ConfigMaps (list)
- Services (list)
- Deployments (list)
- CustomResourceDefinitions (list, if using CRDs)

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Validate K8s Deployment
on:
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
          
      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          
      - name: Wait for GitOps deployment
        run: |
          export FEATURE_K8S=true
          node tools/int-k8s.js \
            --run-id ci-${{ github.run_number }} \
            --fgd-file ./manifests/fabric.yaml \
            --wait \
            --max-retries 20 \
            --verbose
```

### Jenkins Pipeline Example

```groovy
pipeline {
    agent any
    
    environment {
        FEATURE_K8S = 'true'
        KUBECONFIG = credentials('k8s-kubeconfig')
    }
    
    stages {
        stage('Validate Deployment') {
            steps {
                script {
                    sh '''
                        node tools/int-k8s.js \
                          --run-id jenkins-${BUILD_NUMBER} \
                          --fgd-file ./generated/fabric.yaml \
                          --wait \
                          --verbose
                    '''
                }
            }
        }
    }
}
```

## Development

### Running Tests

```bash
# Unit tests (no cluster required)
npm test src/services/k8s.service.test.ts

# Integration tests (requires cluster)
FEATURE_K8S=true npm test -- --grep "integration"
```

### Extending Resource Types

Add new resource types in `K8sProvider.listResourcesInNamespace()`:

```typescript
// Add new resource type
const secrets = await this.k8sApi.listNamespacedSecret(
  namespace, undefined, undefined, undefined, undefined, labelSelector
);
resources.push(...secrets.body.items.map(this.toK8sResource));
```

### Custom Comparison Logic

Extend `K8sProvider.findResourceDifferences()` for spec comparison:

```typescript
// Add spec comparison
if (expected.spec && actual.spec) {
  // Deep comparison logic here
  const specDiffs = compareSpecs(expected.spec, actual.spec);
  differences.push(...specDiffs);
}
```

## Security Considerations

- **Read-only access**: Tool never modifies cluster resources
- **Namespace isolation**: Scoped access prevents interference
- **Feature flag**: Integration disabled by default
- **Kubeconfig security**: Ensure proper kubeconfig file permissions

## Limitations

1. **Read-only**: Cannot create or modify resources
2. **Label dependency**: Resources must have `hncRunId` labels
3. **Basic spec comparison**: Only checks apiVersion and labels by default
4. **No real-time updates**: Polling-based resource checking

## Future Enhancements

- [ ] CRD support for fabric-specific resources
- [ ] Deep spec comparison for all resource types
- [ ] Real-time watch-based validation
- [ ] Integration with admission controllers
- [ ] Helm chart validation support
- [ ] Resource status condition checking